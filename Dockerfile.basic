FROM python:3.11-slim

# 使用清华 Debian 源加速
RUN printf "deb http://mirrors.tuna.tsinghua.edu.cn/debian bookworm main contrib non-free non-free-firmware\n\
    deb http://mirrors.tuna.tsinghua.edu.cn/debian-security bookworm-security main contrib non-free non-free-firmware\n\
    deb http://mirrors.tuna.tsinghua.edu.cn/debian bookworm-updates main contrib non-free non-free-firmware\n" > /etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
        texlive \
        texlive-latex-base \
        texlive-latex-recommended \
        texlive-fonts-recommended \
        texlive-lang-chinese \
        texlive-xetex \
        latexmk \
        git \
        ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ---- Python 依赖 ----
WORKDIR /app

# 先复制依赖文件，便于利用 Docker layer cache
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 复制项目源码
COPY . /app

# ---- 构建参数，可在 docker build 时传入 ----
ARG LLM_API_KEY=""
ARG LLM_BASE_URL=""

# 写入环境变量，若 docker run 再次指定会覆盖
ENV LLM_API_KEY=${LLM_API_KEY} \
    LLM_BASE_URL=${LLM_BASE_URL} \
    PYTHONUNBUFFERED=1 \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# 默认执行命令
ENTRYPOINT ["python", "main.py"]
